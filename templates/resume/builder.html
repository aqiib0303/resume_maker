{% extends "base.html" %}
{% block content %}
<div class="max-w-4xl mx-auto bg-white shadow-xl p-8 rounded-2xl">
    <h2 class="text-3xl font-bold mb-8 text-gray-800 flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c0 .667.333 1 1 1h7c.667 0 1-.333 1-1V6c0-.667-.333-1-.333-1h-7c-.667 0-1 .333-1 1v5z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13h2v6H5zM9 13h2v6H9zM13 13h2v6h-2zM17 13h2v6h-2z" />
        </svg>
        Build Your Resume
    </h2>

    <form id="resumeForm" method="POST" action="" class="space-y-8">

        <!-- Personal Info -->
        <div class="p-6 border rounded-xl shadow-sm">
            <h3 class="text-lg font-semibold flex items-center gap-2 mb-4 text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A9 9 0 1117.804 5.12M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                Personal Information
            </h3>
            <div class="grid grid-cols-2 gap-6">
                <div>
                    <label class="block mb-2 text-gray-600">Full Name</label>
                    <input type="text" name="name" class="w-full border rounded-lg p-2" placeholder="John Doe" required>
                </div>
                <div>
                    <label class="block mb-2 text-gray-600">Job Title</label>
                    <input type="text" name="role" class="w-full border rounded-lg p-2" placeholder="Software Engineer" required>
                </div>
                <div>
                    <label class="block mb-2 text-gray-600">Email</label>
                    <input type="email" name="email" class="w-full border rounded-lg p-2" placeholder="example@email.com">
                </div>
                <div>
                    <label class="block mb-2 text-gray-600">Phone</label>
                    <input type="text" name="phone" class="w-full border rounded-lg p-2" placeholder="+1 123 456 7890">
                </div>
            </div>
        </div>

        <!-- Summary -->
        <div class="p-6 border rounded-xl shadow-sm">
            <h3 class="text-lg font-semibold flex items-center gap-2 mb-4 text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 20h9" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4h9m-9 4h6m-6 4h6m-6 4h6" />
                </svg>
                Professional Summary
            </h3>
            <textarea name="summary" rows="3" class="w-full border rounded-lg p-2" placeholder="Write a short professional summary..."></textarea>
        </div>

        <!-- Skills -->
        <div class="p-6 border rounded-xl shadow-sm">
            <h3 class="text-lg font-semibold flex items-center gap-2 mb-4 text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m-6-8h6" />
                </svg>
                Skills
            </h3>
            <input type="text" name="skills[]" class="w-full border rounded-lg p-2" placeholder="e.g. Python, Flask, SQL">
        </div>

        <!-- Experience -->
        <div class="p-6 border rounded-xl shadow-sm">
            <h3 class="text-lg font-semibold flex items-center gap-2 mb-4 text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-6h13M9 7h13M5 7h.01M5 17h.01M5 12h.01" />
                </svg>
                Work Experience
            </h3>
            <div class="space-y-2">
                <input type="text" name="exp_company[]" class="w-full border rounded-lg p-2" placeholder="Company">
                <input type="text" name="exp_role[]" class="w-full border rounded-lg p-2" placeholder="Role">
                <input type="text" name="exp_dates[]" class="w-full border rounded-lg p-2" placeholder="Dates">
                <textarea name="exp_desc[]" rows="2" class="w-full border rounded-lg p-2" placeholder="Description of responsibilities..."></textarea>
            </div>
        </div>

        <!-- Education -->
        <div class="p-6 border rounded-xl shadow-sm">
            <h3 class="text-lg font-semibold flex items-center gap-2 mb-4 text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5zm0 7v-7m0 0L3 9m9 5l9 5" />
                </svg>
                Education
            </h3>
            <div class="space-y-2">
                <input type="text" name="edu_school[]" class="w-full border rounded-lg p-2" placeholder="School / University">
                <input type="text" name="edu_degree[]" class="w-full border rounded-lg p-2" placeholder="Degree / Program">
                <input type="text" name="edu_dates[]" class="w-full border rounded-lg p-2" placeholder="Dates">
            </div>
        </div>

        <!-- Template Selection -->
        <div class="p-6 border rounded-xl shadow-sm">
            <h3 class="text-lg font-semibold flex items-center gap-2 mb-4 text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" />
                </svg>
                Choose Template
            </h3>
            <select name="style" id="style" class="w-full border rounded-lg p-2">
                <option value="modern">Modern</option>
                <option value="minimal">Minimal</option>
                <option value="creative">Creative</option>
                <option value="ats_friendly">ATS-Friendly</option>
                <option value="ats_modern">ATS-Modern</option>
                <option value="premium_modern_pro">Premium — Modern Pro ⭐</option>
            </select>
        </div>

        <!-- Actions -->
        <div class="flex justify-between mt-8">
            <button type="submit" id="previewBtn"
                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553 4.553a1 1 0 010 1.414L15 20m0 0h-3a8 8 0 01-8-8V4a2 2 0 012-2h4" />
                </svg>
                Preview Resume
            </button>
        </div>
    </form>

    <!-- Preview Section -->
    <div id="previewContainer" class="mt-10 hidden">
        <h3 class="text-xl font-semibold mb-4 text-gray-700">Resume Preview</h3>
        <iframe id="resumePreview" class="w-full h-[600px] border rounded-lg shadow"></iframe>

        <!-- Download button -->
        <div id="downloadForm" class="mt-4 text-right"></div>
    </div>
</div>

<script>
document.getElementById("previewBtn").addEventListener("click", function(e) {
    e.preventDefault();
    let style = document.getElementById("style").value;
    let form = document.getElementById("resumeForm");
    let formData = new FormData(form);

    fetch("/resume/preview/" + style, {
        method: "POST",
        body: formData
    })
    .then(res => res.text())
    .then(html => {
        document.getElementById("previewContainer").classList.remove("hidden");
        document.getElementById("resumePreview").srcdoc = html;

        // ✅ Extract token from preview HTML
        let tokenMatch = html.match(/data-token="([^"]+)"/);
        let token = tokenMatch ? tokenMatch[1] : null;

        const downloadForm = document.getElementById("downloadForm");
        if (token) {
            downloadForm.innerHTML = `
                <a href="/resume/download/${token}" 
                   class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Download PDF
                </a>
            `;
        } else {
            downloadForm.innerHTML = `<p class="text-red-500">⚠️ Could not generate token for download.</p>`;
        }
    });
});

// ✅ Auto-select template from query parameter (?style=...)
window.addEventListener("DOMContentLoaded", function() {
    const urlParams = new URLSearchParams(window.location.search);
    const styleParam = urlParams.get("style");
    if (styleParam) {
        const styleSelect = document.getElementById("style");
        if (styleSelect.querySelector(`option[value="${styleParam}"]`)) {
            styleSelect.value = styleParam;
        }
    }
});
</script>
{% endblock %}
